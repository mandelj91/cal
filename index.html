<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Cal">
  <meta name="theme-color" content="#000">
  <title>Cal</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
    
    :root {
      --bg: #000;
      --surface: #0a0a0a;
      --card: #111;
      --border: #1a1a1a;
      --border-subtle: #141414;
      --text: #fafafa;
      --text-secondary: #888;
      --text-tertiary: #444;
      --accent: #22c55e;
      --accent-dim: #166534;
      --protein: #3b82f6;
      --carbs: #eab308;
      --fat: #ef4444;
      --warning: #f59e0b;
      --purple: #a855f7;
      --orange: #f97316;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    html, body { 
      font-family: 'Inter', -apple-system, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    
    body {
      padding-top: var(--safe-top);
      padding-bottom: calc(56px + var(--safe-bottom));
    }
    
    .mono { font-family: 'JetBrains Mono', monospace; }
    .label { font-size: 10px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text-tertiary); }
    .value { font-size: 32px; font-weight: 700; font-family: 'JetBrains Mono', monospace; letter-spacing: -1px; }
    .value-sm { font-size: 20px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .value-xs { font-size: 14px; font-weight: 500; font-family: 'JetBrains Mono', monospace; }
    .positive { color: var(--accent); }
    .negative { color: var(--fat); }
    .warning { color: var(--warning); }
    .burn { color: var(--orange); }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-subtle);
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-right { display: flex; align-items: center; gap: 8px; }
    
    .date-nav { display: flex; align-items: center; gap: 8px; }
    .date-btn {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
    }
    .date-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .date-label { font-size: 12px; font-weight: 600; letter-spacing: 0.5px; min-width: 60px; text-align: center; }
    
    .icon-btn {
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
    }
    .icon-btn:disabled { opacity: 0.3; }
    
    .content { padding: 0 16px 24px; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
      padding-top: 16px;
    }
    
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }
    
    .stat-card.wide {
      grid-column: span 2;
    }
    
    .stat-label { margin-bottom: 4px; }
    .stat-sublabel { font-size: 9px; color: var(--text-tertiary); margin-top: 2px; }
    
    .macros-row {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .macro-pill {
      flex: 1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 8px;
      text-align: center;
    }
    
    .macro-value { font-size: 16px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .macro-label { font-size: 9px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
    .macro-pill.protein .macro-value { color: var(--protein); }
    .macro-pill.carbs .macro-value { color: var(--carbs); }
    .macro-pill.fat .macro-value { color: var(--fat); }
    
    .section-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--text-tertiary);
      margin-bottom: 12px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 44px;
      padding: 0 20px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-sm { height: 36px; padding: 0 14px; font-size: 13px; }
    .btn-full { width: 100%; }
    
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: var(--surface);
      padding: 4px;
      border-radius: 8px;
    }
    .tab {
      flex: 1;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    .tab.active { background: var(--card); color: var(--text); }
    
    .input {
      width: 100%;
      height: 44px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0 12px;
      font-size: 14px;
      font-family: inherit;
      color: var(--text);
    }
    .input:focus { outline: none; border-color: var(--accent-dim); }
    .input::placeholder { color: var(--text-tertiary); }
    
    .textarea {
      width: 100%;
      min-height: 100px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      font-family: inherit;
      color: var(--text);
      resize: vertical;
    }
    .textarea:focus { outline: none; border-color: var(--accent-dim); }
    
    .quick-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .quick-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.15s;
    }
    .quick-item:hover { border-color: var(--accent-dim); }
    .quick-item.active { border-color: var(--accent); background: rgba(34, 197, 94, 0.05); }
    .quick-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
    .quick-meta { font-size: 11px; color: var(--text-secondary); }
    .quick-cal { color: var(--accent); font-weight: 600; }
    
    .food-list { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
    
    .food-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    .food-info { flex: 1; min-width: 0; }
    .food-name { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .food-detail { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    .food-cal { font-size: 16px; font-weight: 600; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
    .food-cal.burn { color: var(--orange); }
    .food-delete {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      background: transparent;
      border: none;
      color: var(--fat);
      font-size: 18px;
      cursor: pointer;
    }
    
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-tertiary);
      font-size: 13px;
    }
    
    .workout-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .workout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .workout-title { font-size: 16px; font-weight: 600; }
    .workout-badge {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 4px;
      background: var(--accent);
      color: #000;
      font-weight: 600;
    }
    .workout-time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .workout-burn {
      font-size: 11px;
      color: var(--orange);
      font-weight: 500;
    }
    
    .exercise-list { display: flex; flex-direction: column; gap: 8px; }
    
    .exercise-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--surface);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .set-counter {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px;
      min-width: 90px;
    }
    
    .set-btn {
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .set-btn:hover { background: var(--surface); color: var(--text); }
    .set-btn:active { transform: scale(0.95); }
    
    .set-display {
      flex: 1;
      text-align: center;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .set-display.partial { color: var(--warning); }
    .set-display.complete { color: var(--accent); }
    
    .exercise-check {
      width: 24px; height: 24px;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--accent);
      flex-shrink: 0;
    }
    .exercise-check.done { background: var(--accent); border-color: var(--accent); color: #000; }
    
    .exercise-info { flex: 1; min-width: 0; }
    .exercise-name { font-size: 13px; font-weight: 500; }
    .exercise-detail { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    
    .workout-progress {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: var(--surface);
      border-radius: 6px;
    }
    .progress-bar {
      flex: 1;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }
    .progress-text {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }
    
    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .chart-title { font-size: 11px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
    .chart-bars { display: flex; align-items: flex-end; justify-content: space-between; height: 80px; gap: 4px; }
    .chart-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .chart-bar { width: 100%; background: var(--surface); border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; }
    .chart-bar-fill { background: var(--accent); width: 100%; transition: height 0.3s; }
    .chart-bar-value { font-size: 10px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; height: 14px; }
    .chart-bar-label { font-size: 10px; color: var(--text-tertiary); }
    
    .stats-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-box {
      flex: 1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    .stat-box-value { font-size: 20px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .stat-box-label { font-size: 10px; color: var(--text-tertiary); text-transform: uppercase; margin-top: 4px; }
    
    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .input-row .input { flex: 1; }
    
    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      display: flex;
      padding-bottom: var(--safe-bottom);
      z-index: 100;
    }
    
    .nav-item {
      flex: 1;
      padding: 10px 0 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: transparent;
      border: none;
      color: var(--text-tertiary);
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
    }
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 18px; font-weight: 400; }
    
    .page { display: none; }
    .page.active { display: block; }
    
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 340px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--card);
    }
    
    .modal-title { font-size: 14px; font-weight: 600; }
    
    .modal-close {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
    }
    
    .modal-content { padding: 16px; }
    
    .modal-input {
      width: 100%;
      height: 44px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0 12px;
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text);
      margin-bottom: 12px;
    }
    .modal-input:focus { outline: none; border-color: var(--accent-dim); }
    
    .modal-hint {
      font-size: 12px;
      color: var(--text-tertiary);
      line-height: 1.6;
      margin-bottom: 16px;
    }
    .modal-hint a { color: var(--accent); }
    
    .hidden { display: none !important; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }
    .mt-16 { margin-top: 16px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="date-nav">
        <button class="date-btn" id="prevDay">&lt;</button>
        <span class="date-label" id="dateLabel">TODAY</span>
        <button class="date-btn" id="nextDay">&gt;</button>
      </div>
    </div>
    <div class="header-right">
      <button class="icon-btn" id="undoBtn" disabled title="Undo">&#x21ba;</button>
      <button class="icon-btn" id="menuBtn" title="Menu">&#xb7;&#xb7;&#xb7;</button>
    </div>
  </header>
  
  <main class="page active" id="foodPage">
    <div class="content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label stat-label">Eaten</div>
          <div class="value" id="calValue">0</div>
        </div>
        <div class="stat-card">
          <div class="label stat-label">Burned</div>
          <div class="value burn" id="burnValue">0</div>
        </div>
        <div class="stat-card">
          <div class="label stat-label">Net</div>
          <div class="value-sm positive" id="netValue">0</div>
          <div class="stat-sublabel">Eaten - Burned</div>
        </div>
        <div class="stat-card">
          <div class="label stat-label">True Deficit</div>
          <div class="value-sm positive" id="trueDeficitValue">2000</div>
          <div class="stat-sublabel">TDEE + Burn - Eaten</div>
        </div>
      </div>
      
      <div class="macros-row">
        <div class="macro-pill protein">
          <div class="macro-value" id="proteinValue">0g</div>
          <div class="macro-label">Protein</div>
        </div>
        <div class="macro-pill carbs">
          <div class="macro-value" id="carbsValue">0g</div>
          <div class="macro-label">Carbs</div>
        </div>
        <div class="macro-pill fat">
          <div class="macro-value" id="fatValue">0g</div>
          <div class="macro-label">Fat</div>
        </div>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-tab="describe">Describe</button>
        <button class="tab" data-tab="quick">Quick Add</button>
        <button class="tab" data-tab="barcode">Barcode</button>
      </div>
      
      <div id="describeTab">
        <textarea class="textarea" id="aiInput" placeholder="Describe what you ate...&#10;&#10;Example: 2 scrambled eggs with cheese, 2 strips of bacon, black coffee"></textarea>
        <button class="btn btn-full mt-16" onclick="aiAnalyze()">Analyze</button>
        <div id="aiResult" class="hidden mt-16"></div>
      </div>
      
      <div id="quickTab" class="hidden">
        <input type="text" class="input mb-12" id="quickSearch" placeholder="Search foods...">
        <div class="quick-grid" id="quickGrid"></div>
      </div>
      
      <div id="barcodeTab" class="hidden">
        <input type="text" class="input" id="barcodeInput" placeholder="Enter barcode number">
        <button class="btn btn-full mt-16" onclick="lookupBarcode()">Look Up</button>
        <div id="barcodeResult" class="hidden mt-16"></div>
      </div>
      
      <div class="section-title mt-16">Today's Log</div>
      <div class="food-list" id="foodList"></div>
    </div>
  </main>
  
  <main class="page" id="workoutPage">
    <div class="content" style="padding-top:16px">
      <div id="workoutSelection">
        <div class="section-title">Choose Workout</div>
        <div class="quick-grid mb-16">
          <button class="quick-item" onclick="selectCategory('push')">
            <div class="quick-name">Push</div>
            <div class="quick-meta">Chest / Shoulders / Triceps</div>
          </button>
          <button class="quick-item" onclick="selectCategory('pull')">
            <div class="quick-name">Pull</div>
            <div class="quick-meta">Back / Biceps</div>
          </button>
          <button class="quick-item" onclick="selectCategory('legs')">
            <div class="quick-name">Legs</div>
            <div class="quick-meta">Quads / Glutes / Core</div>
          </button>
          <button class="quick-item" onclick="selectCategory('full')">
            <div class="quick-name">Full Body</div>
            <div class="quick-meta">Circuit Training</div>
          </button>
          <button class="quick-item" onclick="selectCategory('quick')">
            <div class="quick-name">Quick 15</div>
            <div class="quick-meta">Time-Efficient</div>
          </button>
          <button class="quick-item" onclick="selectCategory('apartment')">
            <div class="quick-name">Apartment</div>
            <div class="quick-meta">No Jumping / Quiet</div>
          </button>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary btn-full" onclick="surpriseMe()">Surprise Me</button>
          <button class="btn btn-secondary btn-full" onclick="apartmentSurprise()">Apt Mode</button>
        </div>
      </div>
      
      <div id="customLogSection">
        <div class="section-title mt-16">Log Custom Workout</div>
        <div class="tabs mb-16">
          <button class="tab active" data-extab="describe">Describe</button>
          <button class="tab" data-extab="quicklog">Quick Log</button>
          <button class="tab" data-extab="manualex">Manual</button>
        </div>
        
        <div id="describeExTab">
          <textarea class="textarea" id="exAiInput" placeholder="Describe your workout...&#10;&#10;Example: 30 minute full body workout with push-ups, squats, and planks&#10;Example: walked 2 miles at a brisk pace&#10;Example: 45 min gym session, chest and triceps"></textarea>
          <button class="btn btn-full mt-16" onclick="aiAnalyzeWorkout()">Analyze</button>
          <div id="exAiResult" class="hidden mt-16"></div>
        </div>
        
        <div id="quicklogTab" class="hidden">
          <div class="quick-grid" id="quickExGrid"></div>
        </div>
        
        <div id="manualexTab" class="hidden">
          <input type="text" class="input mb-12" id="manualExName" placeholder="Workout name (e.g., Morning run)">
          <input type="number" class="input mb-12" id="manualExMins" placeholder="Duration (minutes)">
          <div class="quick-grid mb-12">
            <button class="quick-item" id="intLow" onclick="setIntensity('low')">
              <div class="quick-name">Low</div>
              <div class="quick-meta">3 cal/min · Walk, yoga</div>
            </button>
            <button class="quick-item" id="intMed" onclick="setIntensity('med')">
              <div class="quick-name">Medium</div>
              <div class="quick-meta">5 cal/min · Strength</div>
            </button>
            <button class="quick-item" id="intHigh" onclick="setIntensity('high')">
              <div class="quick-name">High</div>
              <div class="quick-meta">7 cal/min · HIIT, run</div>
            </button>
            <button class="quick-item" id="intVHigh" onclick="setIntensity('vhigh')">
              <div class="quick-name">Very High</div>
              <div class="quick-meta">9 cal/min · Sprint</div>
            </button>
          </div>
          <button class="btn btn-full" onclick="addManualEx()">Log Workout</button>
        </div>
      </div>
      
      <div id="activeWorkout" class="hidden">
        <div class="workout-card">
          <div class="workout-header">
            <div>
              <div class="workout-title" id="workoutTitle">Push A</div>
              <div class="workout-time"><span id="workoutBadge">Chest Focus</span> · <span id="workoutTime">25</span> min</div>
              <div class="workout-burn">Est. burn: <span id="workoutEstBurn">125</span> cal</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="shuffleWorkout()">Shuffle</button>
          </div>
          
          <div class="workout-progress">
            <div class="progress-bar"><div class="progress-fill" id="workoutProgressFill" style="width:0%"></div></div>
            <div class="progress-text" id="workoutProgressText">0%</div>
          </div>
          
          <div class="exercise-list" id="exerciseList"></div>
          
          <div style="display:flex;gap:8px;margin-top:16px">
            <button class="btn btn-secondary btn-full" onclick="cancelWorkout()">Cancel</button>
            <button class="btn btn-full" id="completeBtn" onclick="completeWorkout()">Complete</button>
          </div>
        </div>
      </div>
      
      <div class="section-title mt-16">Today's Exercise</div>
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-value burn" id="todayBurnTotal">0</div>
          <div class="stat-box-label">Cal Burned</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="todayWorkoutMins">0</div>
          <div class="stat-box-label">Minutes</div>
        </div>
      </div>
      <div id="exLog"></div>
      
      <div class="section-title mt-16">Stats</div>
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-value" id="workoutCount">0</div>
          <div class="stat-box-label">Total Workouts</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="weekWorkouts">0</div>
          <div class="stat-box-label">This Week</div>
        </div>
      </div>
    </div>
  </main>
  
  <main class="page" id="trendsPage">
    <div class="content" style="padding-top:16px">
      <div class="section-title">Activity (Manual Entry)</div>
      <div class="input-row">
        <input type="number" class="input" id="stepsInput" placeholder="Steps">
        <button class="btn btn-secondary" onclick="logSteps()">Log</button>
      </div>
      <div class="input-row">
        <input type="number" class="input" id="activeCalInput" placeholder="Extra Active Cal">
        <button class="btn btn-secondary" onclick="logActiveCal()">Log</button>
      </div>
      
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-value" id="todaySteps">0</div>
          <div class="stat-box-label">Steps</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value burn" id="todayTotalBurn">0</div>
          <div class="stat-box-label">Total Burn</div>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-title">Calories Eaten (7 Day)</div>
        <div class="chart-bars" id="calChart"></div>
      </div>
      
      <div class="chart-card">
        <div class="chart-title">Calories Burned (7 Day)</div>
        <div class="chart-bars" id="burnChart"></div>
      </div>
      
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-value positive" id="avgCal">0</div>
          <div class="stat-box-label">Avg Eaten</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value burn" id="avgBurn">0</div>
          <div class="stat-box-label">Avg Burn</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="avgP">0g</div>
          <div class="stat-box-label">Avg Protein</div>
        </div>
      </div>
      
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-value positive" id="avgTrueDeficit">0</div>
          <div class="stat-box-label">Avg True Deficit</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value positive" id="lbWk">0</div>
          <div class="stat-box-label">Proj. lb/wk</div>
        </div>
      </div>
      
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-value positive" id="deficitStreak">0</div>
          <div class="stat-box-label">Deficit Streak</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="proteinStreak">0</div>
          <div class="stat-box-label">Protein Streak</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value burn" id="workoutStreak">0</div>
          <div class="stat-box-label">Workout Streak</div>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-title">Weight Trend</div>
        <div class="chart-bars" id="weightChart"></div>
      </div>
      
      <div class="input-row">
        <input type="number" class="input" id="weightInput" placeholder="Log weight (lb)" step="0.1">
        <button class="btn btn-secondary" onclick="logWeight()">Log</button>
      </div>
    </div>
  </main>
  
  <main class="page" id="morePage">
    <div class="content" style="padding-top:16px">
      <div class="section-title">Progress</div>
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-value" id="curWt">--</div>
          <div class="stat-box-label">Current</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="goalWt">--</div>
          <div class="stat-box-label">Goal</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value positive" id="toLose">--</div>
          <div class="stat-box-label">To Go</div>
        </div>
      </div>
      
      <div class="section-title mt-16">Settings</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-secondary btn-full" onclick="openModal('apiModal')">API Key</button>
        <button class="btn btn-secondary btn-full" onclick="exportData()">Export Data</button>
        <label class="btn btn-secondary btn-full" style="cursor:pointer">
          Import Data
          <input type="file" accept=".json" onchange="importData(event)" style="display:none">
        </label>
        <button class="btn btn-secondary btn-full" onclick="clearData()" style="color:var(--fat)">Clear All Data</button>
      </div>
      
      <div style="text-align:center;margin-top:32px;color:var(--text-tertiary);font-size:11px">
        Cal v3.6 (custom workout logging)
      </div>
    </div>
  </main>
  
  <nav>
    <button class="nav-item active" data-page="food">
      <span class="nav-icon">&#9679;</span>
      Food
    </button>
    <button class="nav-item" data-page="workout">
      <span class="nav-icon">&#9651;</span>
      Train
    </button>
    <button class="nav-item" data-page="trends">
      <span class="nav-icon">&#9650;</span>
      Trends
    </button>
    <button class="nav-item" data-page="more">
      <span class="nav-icon">&#9776;</span>
      More
    </button>
  </nav>
  
  <div class="modal-overlay" id="apiModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Anthropic API Key</div>
        <button class="modal-close" onclick="closeModal('apiModal')">&times;</button>
      </div>
      <div class="modal-content">
        <input type="password" class="modal-input" id="apiKeyInput" placeholder="sk-ant-...">
        <div class="modal-hint">Get your key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></div>
        <button class="btn btn-full" id="saveApiKeyBtn">Save</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="menuModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Quick Actions</div>
        <button class="modal-close" onclick="closeModal('menuModal')">&times;</button>
      </div>
      <div class="modal-content">
        <button class="btn btn-secondary btn-full mb-12" onclick="closeModal('menuModal');openModal('manualModal')">Manual Entry</button>
        <button class="btn btn-secondary btn-full" onclick="closeModal('menuModal');openModal('apiModal')">API Settings</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="manualModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Manual Entry</div>
        <button class="modal-close" onclick="closeModal('manualModal')">&times;</button>
      </div>
      <div class="modal-content">
        <input type="text" class="modal-input" id="manualName" placeholder="Food name">
        <input type="number" class="modal-input" id="manualCal" placeholder="Calories">
        <input type="number" class="modal-input" id="manualP" placeholder="Protein (g)">
        <input type="number" class="modal-input" id="manualC" placeholder="Carbs (g)">
        <input type="number" class="modal-input" id="manualF" placeholder="Fat (g)">
        <button class="btn btn-full" onclick="addManual()">Add</button>
      </div>
    </div>
  </div>

<script>
const C={cal:1500,protein:130,carbs:110,fat:55,tdee:2000,goalWt:175,key:'cal-data-v3',apiKey:'cal-api-key'};

const FOODS=[
{n:'Turkey Chili (1 cup)',cal:350,p:35,c:25,f:12},{n:'Greek Wrap',cal:390,p:32,c:28,f:16},
{n:'Chicken Stir Fry',cal:435,p:38,c:30,f:14},{n:'Chicken Quesadilla',cal:380,p:30,c:26,f:15},
{n:'Scrambled Eggs (2)',cal:180,p:12,c:2,f:14},{n:'Protein Bar',cal:200,p:20,c:22,f:8},
{n:'Greek Yogurt (1 cup)',cal:130,p:17,c:8,f:0},{n:'Banana',cal:105,p:1,c:27,f:0},
{n:'Apple',cal:95,p:0,c:25,f:0},{n:'Chicken Breast (6oz)',cal:280,p:52,c:0,f:6},
{n:'Rice (1 cup cooked)',cal:205,p:4,c:45,f:0},{n:'Oatmeal (1 cup)',cal:150,p:5,c:27,f:3},
{n:'Coffee (black)',cal:5,p:0,c:0,f:0},{n:'Coffee w/ Oat Milk',cal:45,p:1,c:7,f:1},
{n:'Almonds (1oz)',cal:165,p:6,c:6,f:14},{n:'Avocado (half)',cal:160,p:2,c:8,f:15},
{n:'Salmon (6oz)',cal:350,p:40,c:0,f:20},{n:'Broccoli (1 cup)',cal:55,p:4,c:11,f:0},
{n:'Sweet Potato',cal:115,p:2,c:27,f:0},{n:'Cottage Cheese (1 cup)',cal:220,p:28,c:8,f:10},
];

const WORKOUTS={
push:[
{id:'push-1',name:'Push A',tag:'Chest Focus',time:25,calPerMin:5,ex:[{n:'DB Floor Press',d:'3x12 @ 20-25 lb'},{n:'DB Shoulder Press',d:'3x12 @ 15-20 lb'},{n:'Push-ups',d:'3x15'},{n:'Tricep Dips (chair)',d:'3x12'},{n:'Plank',d:'3x30s'}]},
{id:'push-2',name:'Push B',tag:'Shoulder Focus',time:25,calPerMin:5,ex:[{n:'Arnold Press',d:'3x12 @ 15 lb'},{n:'Incline Push-ups',d:'3x15'},{n:'Lateral Raises',d:'3x15 @ 10 lb'},{n:'Diamond Push-ups',d:'3x10'},{n:'Overhead Tricep Ext',d:'3x12 @ 20 lb'}]},
{id:'push-3',name:'Push C',tag:'Volume',time:30,calPerMin:5,ex:[{n:'DB Floor Press',d:'4x10 @ 25 lb'},{n:'Pike Push-ups',d:'3x10'},{n:'Close-grip Push-ups',d:'3x12'},{n:'Front Raises',d:'3x12 @ 10 lb'},{n:'Tricep Kickbacks',d:'3x12 @ 10 lb'},{n:'Plank Shoulder Taps',d:'3x20'}]},
],
pull:[
{id:'pull-1',name:'Pull A',tag:'Back Focus',time:25,calPerMin:5,ex:[{n:'DB Bent Over Rows',d:'3x12 each @ 20-25 lb'},{n:'DB Bicep Curls',d:'3x12 @ 15-20 lb'},{n:'Reverse Flys',d:'3x12 @ 10-15 lb'},{n:'Superman Hold',d:'3x20s'},{n:'Dead Bug',d:'3x10 each'}]},
{id:'pull-2',name:'Pull B',tag:'Bicep Focus',time:25,calPerMin:5,ex:[{n:'Hammer Curls',d:'3x12 @ 15 lb'},{n:'Single-arm Rows',d:'3x10 each @ 25 lb'},{n:'Concentration Curls',d:'3x10 each @ 15 lb'},{n:'Prone Y Raises',d:'3x12'},{n:'Supermans',d:'3x15'}]},
{id:'pull-3',name:'Pull C',tag:'Strength',time:30,calPerMin:5,ex:[{n:'Renegade Rows',d:'3x8 each @ 20 lb'},{n:'Zottman Curls',d:'3x10 @ 15 lb'},{n:'Wide Rows',d:'3x12 @ 20 lb'},{n:'Face Pulls (band)',d:'3x15'},{n:'Reverse Plank',d:'3x20s'},{n:'Hollow Hold',d:'3x20s'}]},
],
legs:[
{id:'legs-1',name:'Legs A',tag:'Quad Focus',time:25,calPerMin:5,ex:[{n:'Goblet Squats',d:'3x15 @ 20-25 lb'},{n:'Reverse Lunges',d:'3x10 each'},{n:'Bulgarian Split Squat',d:'3x8 each'},{n:'Wall Sit',d:'3x30s'},{n:'Leg Raises',d:'3x15'}]},
{id:'legs-2',name:'Legs B',tag:'Glute/Ham',time:25,calPerMin:5,ex:[{n:'Romanian Deadlift',d:'3x12 @ 20-25 lb'},{n:'Hip Thrusts',d:'3x15 @ 25 lb'},{n:'Sumo Squats',d:'3x12 @ 25 lb'},{n:'Single-leg RDL',d:'3x8 each'},{n:'Glute Bridges',d:'3x20'}]},
{id:'legs-3',name:'Legs C',tag:'Core Combo',time:30,calPerMin:5,ex:[{n:'Goblet Squats',d:'4x12 @ 25 lb'},{n:'Walking Lunges',d:'3x10 each'},{n:'Calf Raises',d:'3x20'},{n:'Russian Twists',d:'3x20 @ 15 lb'},{n:'Bicycle Crunches',d:'3x20'},{n:'Plank',d:'3x45s'}]},
],
full:[
{id:'full-1',name:'Full Body A',tag:'Circuit',time:30,calPerMin:6,ex:[{n:'3 rounds, 45s rest',d:''},{n:'Squats',d:'15 reps'},{n:'Push-ups',d:'10 reps'},{n:'DB Rows',d:'10 each'},{n:'Mountain Climbers',d:'20 total'},{n:'Plank',d:'30s'}]},
{id:'full-2',name:'Full Body B',tag:'Strength',time:35,calPerMin:5,ex:[{n:'Goblet Squats',d:'3x12 @ 25 lb'},{n:'DB Floor Press',d:'3x12 @ 20 lb'},{n:'DB Rows',d:'3x12 each @ 20 lb'},{n:'Lunges',d:'3x10 each'},{n:'Shoulder Press',d:'3x12 @ 15 lb'},{n:'Dead Bug',d:'3x10 each'}]},
{id:'full-3',name:'Full Body C',tag:'Metabolic',time:25,calPerMin:7,ex:[{n:'Burpees (no jump)',d:'3x8'},{n:'DB Thrusters',d:'3x12 @ 15 lb'},{n:'Renegade Rows',d:'3x8 each'},{n:'Jump Squats',d:'3x12'},{n:'Plank Jacks',d:'3x20'}]},
],
quick:[
{id:'quick-1',name:'Quick Core',tag:'15 min',time:15,calPerMin:5,ex:[{n:'Plank',d:'3x45s'},{n:'Dead Bug',d:'3x10 each'},{n:'Russian Twists',d:'3x20'},{n:'Leg Raises',d:'3x15'},{n:'Bird Dog',d:'3x10 each'}]},
{id:'quick-2',name:'Quick Upper',tag:'15 min',time:15,calPerMin:5,ex:[{n:'Push-ups',d:'3x12'},{n:'DB Rows',d:'3x10 each'},{n:'Shoulder Press',d:'3x12 @ 15 lb'},{n:'Bicep Curls',d:'3x12 @ 15 lb'},{n:'Tricep Dips',d:'3x12'}]},
{id:'quick-3',name:'Quick Lower',tag:'15 min',time:15,calPerMin:5,ex:[{n:'Squats',d:'3x15'},{n:'Lunges',d:'3x10 each'},{n:'Glute Bridges',d:'3x20'},{n:'Calf Raises',d:'3x20'},{n:'Wall Sit',d:'3x30s'}]},
],
apartment:[
{id:'apt-1',name:'Apt Push',tag:'Quiet',time:20,calPerMin:4,ex:[{n:'DB Floor Press',d:'3x12 @ 20 lb'},{n:'Slow Push-ups',d:'3x10 (3s down)'},{n:'Shoulder Press',d:'3x12 @ 15 lb'},{n:'Tricep Kickbacks',d:'3x12 @ 10 lb'},{n:'Plank',d:'3x30s'}]},
{id:'apt-2',name:'Apt Pull',tag:'Quiet',time:20,calPerMin:4,ex:[{n:'DB Rows',d:'3x12 each @ 20 lb'},{n:'Bicep Curls',d:'3x12 @ 15 lb'},{n:'Reverse Flys',d:'3x12 @ 10 lb'},{n:'Slow Supermans',d:'3x10 (hold 2s)'},{n:'Dead Bug',d:'3x10 each'}]},
{id:'apt-3',name:'Apt Legs',tag:'Quiet',time:20,calPerMin:4,ex:[{n:'Slow Goblet Squats',d:'3x12 (4s down)'},{n:'Stationary Lunges',d:'3x10 each'},{n:'Romanian DL',d:'3x12 @ 20 lb'},{n:'Glute Bridges',d:'3x15'},{n:'Wall Sit',d:'3x30s'}]},
{id:'apt-4',name:'Apt Full',tag:'Quiet',time:25,calPerMin:4,ex:[{n:'3 rounds, 45s rest',d:''},{n:'Slow Squats',d:'10 reps (4s down)'},{n:'Push-ups',d:'8 reps'},{n:'DB Rows',d:'8 each'},{n:'Glute Bridges',d:'10 reps'},{n:'Plank',d:'30s'}]},
{id:'apt-5',name:'Apt Core',tag:'Quiet',time:15,calPerMin:4,ex:[{n:'Dead Bug',d:'3x10 each'},{n:'Bird Dog',d:'3x10 each'},{n:'Slow Bicycle',d:'3x15'},{n:'Plank',d:'3x45s'},{n:'Side Plank',d:'2x30s each'}]},
],
};

const WORKOUT_CATS=['push','pull','legs','full','quick','apartment'];

const QUICK_EX=[
{n:'30 min Walk',mins:30,calPerMin:3},{n:'45 min Walk',mins:45,calPerMin:3},
{n:'20 min Run',mins:20,calPerMin:10},{n:'30 min Run',mins:30,calPerMin:10},
{n:'30 min Gym',mins:30,calPerMin:5},{n:'45 min Gym',mins:45,calPerMin:5},
{n:'60 min Gym',mins:60,calPerMin:5},{n:'20 min Yoga',mins:20,calPerMin:3},
{n:'30 min Bike',mins:30,calPerMin:7},{n:'20 min HIIT',mins:20,calPerMin:8},
{n:'30 min Swim',mins:30,calPerMin:8},{n:'60 min Hike',mins:60,calPerMin:5},
];

let S={data:{},weights:[],exDone:{},workoutHistory:[],selectedWorkout:null,undo:[],date:null,api:null,exIntensity:'med'};

function localDateStr(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
const today=()=>localDateStr(new Date());
const fmtTime=()=>new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
const fmtDate=d=>new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'});
const dow=d=>new Date(d+'T12:00:00').getDay();

function getDay(d){return S.data[d]||{meals:[],ex:[],totals:{cal:0,p:0,c:0,f:0},steps:0,activeCal:0,burnCal:0};}

function last7(){const days=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days.push(localDateStr(d));}return days;}

function load(){
try{
const s=localStorage.getItem(C.key);
if(s){
  const p=JSON.parse(s);
  S.data=p.data||{};
  S.weights=p.weights||[];
  S.exDone=p.exDone||{};
  S.workoutHistory=p.workoutHistory||[];
  
  // MIGRATION: exDone from array to object format
  for(const date in S.exDone){
    if(Array.isArray(S.exDone[date])){
      const oldArr=S.exDone[date];
      S.exDone[date]={};
      oldArr.forEach(idx=>{S.exDone[date][idx]=99;});
    }
  }
  
  // MIGRATION: Fix meal data format and recalculate totals
  for(const date in S.data){
    const day=S.data[date];
    
    // Ensure arrays exist
    if(!day.meals) day.meals=[];
    if(!day.ex) day.ex=[];
    if(!day.totals) day.totals={cal:0,p:0,c:0,f:0};
    
    // CRITICAL FIX: Migrate meals from nested totals format to flat format
    let needsRecalc = false;
    day.meals.forEach(meal=>{
      // Check if meal uses old format with nested totals
      if(meal.totals && typeof meal.totals === 'object'){
        // Migrate from {name, totals:{cal,p,c,f}} to {name, cal, p, c, f}
        meal.cal = meal.totals.cal || 0;
        meal.p = meal.totals.p || 0;
        meal.c = meal.totals.c || 0;
        meal.f = meal.totals.f || 0;
        delete meal.totals;
        needsRecalc = true;
      }
      // Handle undefined/NaN values
      if(meal.cal === undefined || isNaN(meal.cal)) meal.cal = 0;
      if(meal.p === undefined || isNaN(meal.p)) meal.p = 0;
      if(meal.c === undefined || isNaN(meal.c)) meal.c = 0;
      if(meal.f === undefined || isNaN(meal.f)) meal.f = 0;
    });
    
    // Recalculate day totals from meals (ensures consistency)
    day.totals.cal = day.meals.reduce((sum,m)=>sum+(m.cal||0),0);
    day.totals.p = day.meals.reduce((sum,m)=>sum+(m.p||0),0);
    day.totals.c = day.meals.reduce((sum,m)=>sum+(m.c||0),0);
    day.totals.f = day.meals.reduce((sum,m)=>sum+(m.f||0),0);
    
    // MIGRATION: Calculate burnCal from exercises if missing
    if(day.burnCal===undefined){
      let burnCal=0;
      if(day.ex){
        day.ex.forEach(e=>{if(e.burnCal)burnCal+=e.burnCal;});
      }
      day.burnCal=burnCal;
    }
    
    // Ensure other fields exist
    if(day.steps===undefined) day.steps=0;
    if(day.activeCal===undefined) day.activeCal=0;
  }
  
  // Save migrated data
  save();
}
S.api=localStorage.getItem(C.apiKey);
}catch(e){console.error('Load error:',e);}
}

function save(){try{localStorage.setItem(C.key,JSON.stringify({data:S.data,weights:S.weights,exDone:S.exDone,workoutHistory:S.workoutHistory}));}catch(e){}}

function parseSetCount(d){if(!d)return 0;const m=d.match(/^(\d+)[x×]/i);if(m)return parseInt(m[1],10);if(/^\d+\s*reps?$/i.test(d))return 1;if(/^\d+s$/i.test(d))return 1;return 0;}
function getSetsCompleted(i){return(S.exDone[S.date]||{})[i]||0;}
function setSetsCompleted(i,c){if(!S.exDone[S.date])S.exDone[S.date]={};S.exDone[S.date][i]=c;save();renderWorkout();}
function incrementSet(i,max){const cur=getSetsCompleted(i);setSetsCompleted(i,cur>=max?0:cur+1);}
function decrementSet(i){setSetsCompleted(i,Math.max(0,getSetsCompleted(i)-1));}

function calculateWorkoutBurn(w,pct=100){return Math.round(w.time*(w.calPerMin||5)*(pct/100));}
function getTotalBurn(d){const day=getDay(d);return(day.burnCal||0)+(day.activeCal||0);}

function addFood(name,cal,p,c,f){
  const day=getDay(S.date);
  S.undo.push(JSON.stringify(S.data));
  if(S.undo.length>10)S.undo.shift();
  // Store in flat format (cal, p, c, f as direct properties)
  day.meals.push({id:Date.now(),time:fmtTime(),name,cal:cal||0,p:p||0,c:c||0,f:f||0});
  day.totals.cal+=(cal||0);
  day.totals.p+=(p||0);
  day.totals.c+=(c||0);
  day.totals.f+=(f||0);
  S.data[S.date]=day;
  save();
  render();
}

function deleteFood(id){
  const day=getDay(S.date);
  const meal=day.meals.find(m=>m.id===id);
  if(!meal)return;
  S.undo.push(JSON.stringify(S.data));
  day.meals=day.meals.filter(m=>m.id!==id);
  day.totals.cal-=(meal.cal||0);
  day.totals.p-=(meal.p||0);
  day.totals.c-=(meal.c||0);
  day.totals.f-=(meal.f||0);
  S.data[S.date]=day;
  save();
  render();
}

function undo(){if(S.undo.length===0)return;S.data=JSON.parse(S.undo.pop());save();render();}

async function aiAnalyze(){
const input=document.getElementById('aiInput').value.trim();if(!input)return;if(!S.api){openModal('apiModal');return;}
const resultEl=document.getElementById('aiResult');resultEl.classList.remove('hidden');resultEl.innerHTML='<div style="color:var(--text-secondary)">Analyzing...</div>';
try{
const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':S.api,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,messages:[{role:'user',content:`Analyze this food and estimate calories and macros. Return ONLY valid JSON array, no markdown:\n[{"name":"item name","cal":number,"p":protein_g,"c":carbs_g,"f":fat_g}]\n\nFood: ${input}`}]})});
const data=await res.json();if(data.error)throw new Error(data.error.message);
const text=data.content[0].text;const items=JSON.parse(text.replace(/```json?|```/g,'').trim());
resultEl.innerHTML=items.map((item,i)=>`<div class="food-item" style="cursor:pointer" onclick="confirmAdd(${i})"><div class="food-info"><div class="food-name">${item.name}</div><div class="food-detail">P: ${item.p}g · C: ${item.c}g · F: ${item.f}g</div></div><div class="food-cal">${item.cal}</div></div>`).join('');
window._aiItems=items;
}catch(e){resultEl.innerHTML=`<div style="color:var(--fat)">Error: ${e.message}</div>`;}
}
function confirmAdd(i){const item=window._aiItems[i];if(!item)return;addFood(item.name,item.cal,item.p,item.c,item.f);document.getElementById('aiInput').value='';document.getElementById('aiResult').classList.add('hidden');}

async function lookupBarcode(){
const code=document.getElementById('barcodeInput').value.trim();if(!code)return;
const resultEl=document.getElementById('barcodeResult');resultEl.classList.remove('hidden');resultEl.innerHTML='<div style="color:var(--text-secondary)">Looking up...</div>';
try{
const res=await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);const data=await res.json();if(data.status!==1)throw new Error('Not found');
const p=data.product,n=p.nutriments||{};const item={name:p.product_name||'Unknown',cal:Math.round(n['energy-kcal_100g']||n['energy-kcal']||0),p:Math.round(n.proteins_100g||n.proteins||0),c:Math.round(n.carbohydrates_100g||n.carbohydrates||0),f:Math.round(n.fat_100g||n.fat||0)};
resultEl.innerHTML=`<div class="food-item" style="cursor:pointer" onclick="addBarcodeItem()"><div class="food-info"><div class="food-name">${item.name}</div><div class="food-detail">Per 100g · P: ${item.p}g · C: ${item.c}g · F: ${item.f}g</div></div><div class="food-cal">${item.cal}</div></div>`;
window._barcodeItem=item;
}catch(e){resultEl.innerHTML=`<div style="color:var(--fat)">Not found</div>`;}
}
function addBarcodeItem(){if(!window._barcodeItem)return;const item=window._barcodeItem;addFood(item.name,item.cal,item.p,item.c,item.f);document.getElementById('barcodeInput').value='';document.getElementById('barcodeResult').classList.add('hidden');}

function addManual(){const name=document.getElementById('manualName').value.trim();const cal=parseInt(document.getElementById('manualCal').value)||0;const p=parseInt(document.getElementById('manualP').value)||0;const c=parseInt(document.getElementById('manualC').value)||0;const f=parseInt(document.getElementById('manualF').value)||0;if(!name||!cal)return;addFood(name,cal,p,c,f);closeModal('manualModal');['manualName','manualCal','manualP','manualC','manualF'].forEach(id=>{document.getElementById(id).value='';});}

function renderQuickAdd(filter=''){const grid=document.getElementById('quickGrid');const f=filter.toLowerCase();const items=f?FOODS.filter(food=>food.n.toLowerCase().includes(f)):FOODS;grid.innerHTML=items.map((food,i)=>`<div class="quick-item" onclick="addFood('${food.n.replace(/'/g,"\\'")}',${food.cal},${food.p},${food.c},${food.f})"><div class="quick-name">${food.n}</div><div class="quick-meta"><span class="quick-cal">${food.cal}</span> · P${food.p} C${food.c} F${food.f}</div></div>`).join('');}

function getSmartWorkout(cat){const routines=WORKOUTS[cat];const recentIds=S.workoutHistory.slice(-6);const notRecent=routines.filter(r=>!recentIds.includes(r.id));return notRecent.length>0?notRecent[Math.floor(Math.random()*notRecent.length)]:routines[Math.floor(Math.random()*routines.length)];}
function selectCategory(cat){S.selectedWorkout=getSmartWorkout(cat);if(!S.exDone[S.date])S.exDone[S.date]={};renderWorkout();}
function shuffleWorkout(){if(!S.selectedWorkout)return;const cat=WORKOUT_CATS.find(c=>WORKOUTS[c].some(w=>w.id===S.selectedWorkout.id));if(cat){const routines=WORKOUTS[cat];const others=routines.filter(r=>r.id!==S.selectedWorkout.id);if(others.length>0){S.selectedWorkout=others[Math.floor(Math.random()*others.length)];if(!S.exDone[S.date])S.exDone[S.date]={};renderWorkout();}}}
function surpriseMe(){const cats=WORKOUT_CATS.filter(c=>c!=='apartment');selectCategory(cats[Math.floor(Math.random()*cats.length)]);}
function apartmentSurprise(){selectCategory('apartment');}
function cancelWorkout(){S.selectedWorkout=null;renderWorkout();}

function logEx(name,mins,setsInfo,burnCal){const day=getDay(S.date);day.ex=day.ex||[];day.ex.push({id:Date.now(),time:fmtTime(),name,mins,setsInfo,burnCal});day.burnCal=(day.burnCal||0)+burnCal;S.data[S.date]=day;save();render();}
function deleteEx(id){const day=getDay(S.date);const ex=day.ex.find(e=>e.id===id);if(!ex)return;day.ex=day.ex.filter(e=>e.id!==id);day.burnCal=Math.max(0,(day.burnCal||0)-(ex.burnCal||0));S.data[S.date]=day;save();render();}

function completeWorkout(){
if(!S.selectedWorkout)return;
const w=S.selectedWorkout;let totalSets=0,completedSets=0;
w.ex.forEach((e,i)=>{const maxSets=parseSetCount(e.d);if(maxSets>0){totalSets+=maxSets;completedSets+=Math.min(getSetsCompleted(i),maxSets);}});
const pct=totalSets>0?Math.round((completedSets/totalSets)*100):100;
const setsInfo=`${completedSets}/${totalSets} sets (${pct}%)`;
const burnCal=calculateWorkoutBurn(w,pct);
S.workoutHistory=[...S.workoutHistory.slice(-20),S.selectedWorkout.id];
logEx(w.name+' ('+w.tag+')',w.time,setsInfo,burnCal);
S.selectedWorkout=null;save();renderWorkout();
}

// Custom workout logging functions
function switchExTab(tab){
document.querySelectorAll('[data-extab]').forEach(t=>t.classList.remove('active'));
document.querySelector(`[data-extab="${tab}"]`).classList.add('active');
document.getElementById('describeExTab').classList.toggle('hidden',tab!=='describe');
document.getElementById('quicklogTab').classList.toggle('hidden',tab!=='quicklog');
document.getElementById('manualexTab').classList.toggle('hidden',tab!=='manualex');
if(tab==='quicklog')renderQuickEx();
if(tab==='manualex')updateIntensityUI();
}

async function aiAnalyzeWorkout(){
const input=document.getElementById('exAiInput').value.trim();if(!input)return;if(!S.api){openModal('apiModal');return;}
const resultEl=document.getElementById('exAiResult');resultEl.classList.remove('hidden');resultEl.innerHTML='<div style="color:var(--text-secondary)">Analyzing...</div>';
try{
const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':S.api,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,messages:[{role:'user',content:`Analyze this workout description and estimate calories burned. Consider: walking ~3cal/min, strength training ~5cal/min, running ~10cal/min, HIIT ~8cal/min.

Return ONLY valid JSON, no markdown:
{"name":"short workout name","mins":duration_minutes,"burnCal":estimated_calories}

Workout: ${input}`}]})});
const data=await res.json();if(data.error)throw new Error(data.error.message);
const text=data.content[0].text;const item=JSON.parse(text.replace(/```json?|```/g,'').trim());
resultEl.innerHTML=`<div class="food-item" style="cursor:pointer" onclick="confirmAddEx()"><div class="food-info"><div class="food-name">${item.name}</div><div class="food-detail">${item.mins} min · Tap to log</div></div><div class="food-cal burn">${item.burnCal}</div></div>`;
window._aiEx=item;
}catch(e){resultEl.innerHTML=`<div style="color:var(--fat)">Error: ${e.message}</div>`;}
}

function confirmAddEx(){
const item=window._aiEx;if(!item)return;
logEx(item.name,item.mins,'AI estimated',item.burnCal);
document.getElementById('exAiInput').value='';
document.getElementById('exAiResult').classList.add('hidden');
}

function renderQuickEx(){
const grid=document.getElementById('quickExGrid');
grid.innerHTML=QUICK_EX.map(ex=>{
const burn=ex.mins*ex.calPerMin;
return `<div class="quick-item" onclick="addQuickEx('${ex.n}',${ex.mins},${burn})"><div class="quick-name">${ex.n}</div><div class="quick-meta"><span class="quick-cal" style="color:var(--orange)">${burn} cal</span></div></div>`;
}).join('');
}

function addQuickEx(name,mins,burn){logEx(name,mins,'',burn);}

const INTENSITY_RATES={low:3,med:5,high:7,vhigh:9};

function setIntensity(level){
S.exIntensity=level;
updateIntensityUI();
}

function updateIntensityUI(){
['Low','Med','High','VHigh'].forEach(l=>{
const el=document.getElementById('int'+l.charAt(0).toUpperCase()+l.slice(1).toLowerCase());
if(el)el.classList.toggle('active',S.exIntensity===l.toLowerCase());
});
document.getElementById('intLow').classList.toggle('active',S.exIntensity==='low');
document.getElementById('intMed').classList.toggle('active',S.exIntensity==='med');
document.getElementById('intHigh').classList.toggle('active',S.exIntensity==='high');
document.getElementById('intVHigh').classList.toggle('active',S.exIntensity==='vhigh');
}

function addManualEx(){
const name=document.getElementById('manualExName').value.trim();
const mins=parseInt(document.getElementById('manualExMins').value);
if(!name||!mins||mins<1)return;
const burn=mins*INTENSITY_RATES[S.exIntensity];
logEx(name,mins,S.exIntensity+' intensity',burn);
document.getElementById('manualExName').value='';
document.getElementById('manualExMins').value='';
}

function logSteps(){const val=parseInt(document.getElementById('stepsInput').value);if(!val||val<0)return;const day=getDay(S.date);day.steps=(day.steps||0)+val;S.data[S.date]=day;save();render();document.getElementById('stepsInput').value='';}
function logActiveCal(){const val=parseInt(document.getElementById('activeCalInput').value);if(!val||val<0)return;const day=getDay(S.date);day.activeCal=(day.activeCal||0)+val;S.data[S.date]=day;save();render();document.getElementById('activeCalInput').value='';}
function logWeight(){const val=parseFloat(document.getElementById('weightInput').value);if(!val||val<50||val>500)return;S.weights.push({date:S.date,weight:val});S.weights=S.weights.slice(-30);save();render();document.getElementById('weightInput').value='';}

function exportData(){const blob=new Blob([JSON.stringify({data:S.data,weights:S.weights,exDone:S.exDone,workoutHistory:S.workoutHistory},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`cal-backup-${today()}.json`;a.click();}
function importData(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{try{const imp=JSON.parse(ev.target.result);if(!confirm(`Import ${Object.keys(imp.data||{}).length} days?`))return;S.data=imp.data||{};S.weights=imp.weights||[];S.exDone=imp.exDone||{};S.workoutHistory=imp.workoutHistory||[];save();load();render();alert('Done');}catch{alert('Invalid file');}};reader.readAsText(file);e.target.value='';}
function clearData(){if(!confirm('Clear ALL data?'))return;if(!confirm('Are you sure?'))return;localStorage.removeItem(C.key);S={data:{},weights:[],exDone:{},workoutHistory:[],undo:[],date:today(),api:S.api};render();}

function render(){
const day=getDay(S.date),t=day.totals,totalBurn=getTotalBurn(S.date);
document.getElementById('dateLabel').textContent=S.date===today()?'TODAY':fmtDate(S.date);
document.getElementById('nextDay').disabled=S.date===today();
document.getElementById('undoBtn').disabled=S.undo.length===0;

document.getElementById('calValue').textContent=t.cal;
document.getElementById('calValue').style.color=t.cal>C.cal?'var(--fat)':'var(--accent)';
document.getElementById('burnValue').textContent=totalBurn;

const net=t.cal-totalBurn;
const netEl=document.getElementById('netValue');
netEl.textContent=net;
netEl.className='value-sm '+(net<=C.cal?'positive':'negative');

const trueDeficit=C.tdee+totalBurn-t.cal;
const trueDefEl=document.getElementById('trueDeficitValue');
trueDefEl.textContent=trueDeficit;
trueDefEl.className='value-sm '+(trueDeficit>=500?'positive':trueDeficit>0?'warning':'negative');

document.getElementById('proteinValue').textContent=t.p+'g';
document.getElementById('carbsValue').textContent=t.c+'g';
document.getElementById('fatValue').textContent=t.f+'g';

const foodList=document.getElementById('foodList');
foodList.innerHTML=day.meals.length===0?'<div class="empty-state">No food logged yet</div>':day.meals.map(m=>`<div class="food-item"><div class="food-info"><div class="food-name">${m.name}</div><div class="food-detail">${m.time} · P${m.p||0} C${m.c||0} F${m.f||0}</div></div><div class="food-cal">${m.cal||0}</div><button class="food-delete" onclick="deleteFood(${m.id})">×</button></div>`).join('');

renderQuickAdd();renderWorkout();renderTrends();renderMore();
}

function renderWorkout(){
const selectionEl=document.getElementById('workoutSelection'),activeEl=document.getElementById('activeWorkout');
const customLogEl=document.getElementById('customLogSection');

if(S.selectedWorkout){
selectionEl.classList.add('hidden');
activeEl.classList.remove('hidden');
customLogEl.classList.add('hidden');

const w=S.selectedWorkout;
document.getElementById('workoutTitle').textContent=w.name;
document.getElementById('workoutBadge').textContent=w.tag;
document.getElementById('workoutTime').textContent=w.time;

let totalSets=0,completedSets=0;
document.getElementById('exerciseList').innerHTML=w.ex.map((e,i)=>{
const maxSets=parseSetCount(e.d),done=Math.min(getSetsCompleted(i),maxSets);
if(maxSets>0){totalSets+=maxSets;completedSets+=done;}
if(maxSets===0){const isChecked=getSetsCompleted(i)>0;return `<div class="exercise-item"><div class="exercise-check ${isChecked?'done':''}" onclick="setSetsCompleted(${i},${isChecked?0:1})">${isChecked?'✓':''}</div><div class="exercise-info"><div class="exercise-name">${e.n}</div>${e.d?`<div class="exercise-detail">${e.d}</div>`:''}</div></div>`;}
const status=done===0?'':done>=maxSets?'complete':'partial';
return `<div class="exercise-item"><div class="set-counter"><button class="set-btn" onclick="decrementSet(${i})">−</button><div class="set-display ${status}">${done}/${maxSets}</div><button class="set-btn" onclick="incrementSet(${i},${maxSets})">+</button></div><div class="exercise-info"><div class="exercise-name">${e.n}</div>${e.d?`<div class="exercise-detail">${e.d}</div>`:''}</div></div>`;
}).join('');

const pct=totalSets>0?Math.round((completedSets/totalSets)*100):0;
document.getElementById('workoutProgressFill').style.width=pct+'%';
document.getElementById('workoutProgressText').textContent=pct+'%';

const estBurn=calculateWorkoutBurn(w,100);
document.getElementById('workoutEstBurn').textContent=estBurn;

const completeBtn=document.getElementById('completeBtn');
const actualBurn=calculateWorkoutBurn(w,pct);
completeBtn.textContent=pct===100?`Complete (${estBurn} cal)`:pct>0?`Complete ${pct}% (${actualBurn} cal)`:'Complete Workout';
}else{
selectionEl.classList.remove('hidden');
activeEl.classList.add('hidden');
customLogEl.classList.remove('hidden');
}

const day=getDay(S.date);
const todayBurn=day.burnCal||0;
const todayMins=day.ex?day.ex.reduce((sum,e)=>sum+(e.mins||0),0):0;
document.getElementById('todayBurnTotal').textContent=todayBurn;
document.getElementById('todayWorkoutMins').textContent=todayMins;

document.getElementById('workoutCount').textContent=S.workoutHistory.length;
const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay());
const weekWorkouts=Object.keys(S.data).filter(d=>{const date=new Date(d+'T12:00:00');return date>=weekStart&&S.data[d].ex&&S.data[d].ex.length>0;}).length;
document.getElementById('weekWorkouts').textContent=weekWorkouts;

const exLog=document.getElementById('exLog');
exLog.innerHTML=(!day.ex||day.ex.length===0)?'<div class="empty-state">No workout logged today</div>':day.ex.map(e=>`<div class="food-item"><div class="food-info"><div class="food-name">${e.name}</div><div class="food-detail">${e.time} · ${e.mins} min${e.setsInfo?' · '+e.setsInfo:''}</div></div><div class="food-cal burn">${e.burnCal||0}</div><button class="food-delete" onclick="deleteEx(${e.id})">×</button></div>`).join('');
}

function renderTrends(){
const days=last7();
const data=days.map(d=>{const day=getDay(d);return{date:d,...day.totals,steps:day.steps||0,burn:getTotalBurn(d)};});

const maxCal=Math.max(...data.map(d=>d.cal),C.cal);
document.getElementById('calChart').innerHTML=data.map(d=>{const h=maxCal>0?(d.cal/maxCal)*80:0;const color=d.cal>C.cal?'var(--fat)':'var(--accent)';return `<div class="chart-bar-wrap"><div class="chart-bar-value">${d.cal||''}</div><div class="chart-bar" style="height:80px"><div class="chart-bar-fill" style="height:${h}px;background:${color}"></div></div><div class="chart-bar-label">${fmtDate(d.date).split(' ')[1]}</div></div>`;}).join('');

const maxBurn=Math.max(...data.map(d=>d.burn),200);
document.getElementById('burnChart').innerHTML=data.map(d=>{const h=maxBurn>0?(d.burn/maxBurn)*80:0;return `<div class="chart-bar-wrap"><div class="chart-bar-value">${d.burn||''}</div><div class="chart-bar" style="height:80px"><div class="chart-bar-fill" style="height:${h}px;background:var(--orange)"></div></div><div class="chart-bar-label">${fmtDate(d.date).split(' ')[1]}</div></div>`;}).join('');

const withData=data.filter(d=>d.cal>0);
const avg=k=>withData.length?Math.round(withData.reduce((s,d)=>s+d[k],0)/withData.length):0;
document.getElementById('avgCal').textContent=avg('cal');
document.getElementById('avgBurn').textContent=avg('burn');
document.getElementById('avgP').textContent=avg('p')+'g';

const avgTrueDeficit=withData.length?Math.round(withData.reduce((s,d)=>s+(C.tdee+d.burn-d.cal),0)/withData.length):0;
document.getElementById('avgTrueDeficit').textContent=avgTrueDeficit;
document.getElementById('lbWk').textContent=avgTrueDeficit>0?(avgTrueDeficit*7/3500).toFixed(1):'0';

const todayData=getDay(S.date);
document.getElementById('todaySteps').textContent=todayData.steps||0;
document.getElementById('todayTotalBurn').textContent=getTotalBurn(S.date);

let deficitStreak=0;
for(let i=0;i<30;i++){const d=new Date();d.setDate(d.getDate()-i);const ds=localDateStr(d);const day=getDay(ds);const trueDef=C.tdee+getTotalBurn(ds)-day.totals.cal;if(day.totals.cal>0&&trueDef>=500)deficitStreak++;else if(day.totals.cal>0)break;}
document.getElementById('deficitStreak').textContent=deficitStreak;

let proteinStreak=0;
for(let i=0;i<30;i++){const d=new Date();d.setDate(d.getDate()-i);const day=getDay(localDateStr(d));if(day.totals.p>=C.protein)proteinStreak++;else if(day.totals.cal>0)break;}
document.getElementById('proteinStreak').textContent=proteinStreak;

let workoutStreak=0;
for(let i=0;i<30;i++){const d=new Date();d.setDate(d.getDate()-i);const day=getDay(localDateStr(d));if(day.burnCal>0||day.activeCal>0)workoutStreak++;else if(day.totals.cal>0)break;}
document.getElementById('workoutStreak').textContent=workoutStreak;

const wts=S.weights.slice(-7);
const weightChart=document.getElementById('weightChart');
if(wts.length===0){weightChart.innerHTML='<div class="empty-state">No weight data</div>';}
else{const minW=Math.min(...wts.map(w=>w.weight))-2,maxW=Math.max(...wts.map(w=>w.weight))+2,range=maxW-minW||1;
weightChart.innerHTML=wts.map(w=>{const h=((w.weight-minW)/range)*80;return `<div class="chart-bar-wrap"><div class="chart-bar-value">${w.weight}</div><div class="chart-bar" style="height:80px"><div class="chart-bar-fill" style="height:${h}px;background:var(--purple)"></div></div><div class="chart-bar-label">${fmtDate(w.date).split(' ')[1]}</div></div>`;}).join('');}
}

function renderMore(){
const latest=S.weights.length?S.weights[S.weights.length-1].weight:null;
document.getElementById('curWt').textContent=latest?latest+' lb':'--';
document.getElementById('goalWt').textContent=C.goalWt+' lb';
document.getElementById('toLose').textContent=latest?Math.max(0,latest-C.goalWt)+' lb':'--';
}

function openModal(id){document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}

function switchTab(tab){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
document.getElementById('describeTab').classList.toggle('hidden',tab!=='describe');
document.getElementById('quickTab').classList.toggle('hidden',tab!=='quick');
document.getElementById('barcodeTab').classList.toggle('hidden',tab!=='barcode');
}

function switchPage(page){
document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
document.querySelector(`[data-page="${page}"]`).classList.add('active');
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.getElementById(page+'Page').classList.add('active');
}

function init(){
load();S.date=today();
document.querySelectorAll('.nav-item').forEach(btn=>{btn.onclick=()=>switchPage(btn.dataset.page);});
document.querySelectorAll('.tab').forEach(tab=>{tab.onclick=()=>switchTab(tab.dataset.tab);});
document.querySelectorAll('[data-extab]').forEach(tab=>{tab.onclick=()=>switchExTab(tab.dataset.extab);});
document.getElementById('prevDay').onclick=()=>{const d=new Date(S.date+'T12:00:00');d.setDate(d.getDate()-1);S.date=localDateStr(d);render();};
document.getElementById('nextDay').onclick=()=>{if(S.date===today())return;const d=new Date(S.date+'T12:00:00');d.setDate(d.getDate()+1);S.date=localDateStr(d);render();};
document.getElementById('undoBtn').onclick=undo;
document.getElementById('menuBtn').onclick=()=>openModal('menuModal');
document.getElementById('saveApiKeyBtn').onclick=()=>{const k=document.getElementById('apiKeyInput').value.trim();if(k){S.api=k;localStorage.setItem(C.apiKey,k);closeModal('apiModal');}};
document.getElementById('quickSearch').oninput=e=>renderQuickAdd(e.target.value);
document.getElementById('aiInput').onkeydown=e=>{if(e.key==='Enter'&&(e.metaKey||e.ctrlKey))aiAnalyze();};
document.getElementById('barcodeInput').onkeydown=e=>{if(e.key==='Enter')lookupBarcode();};
document.getElementById('weightInput').onkeydown=e=>{if(e.key==='Enter')logWeight();};
document.getElementById('stepsInput').onkeydown=e=>{if(e.key==='Enter')logSteps();};
document.getElementById('activeCalInput').onkeydown=e=>{if(e.key==='Enter')logActiveCal();};
document.querySelectorAll('.modal-overlay').forEach(overlay=>{overlay.onclick=e=>{if(e.target===overlay)closeModal(overlay.id);};});
render();
}

init();
</script>
</body>
</html>
